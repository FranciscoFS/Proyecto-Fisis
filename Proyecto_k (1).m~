%%
clear all
load('Data.mat')
rng(1);
N = 5;
Indice = [foto.class] == N;
Fotos = foto(Indice);
L = size(Fotos(1).data,1);
I = zeros(L,L,numel(Fotos));
%I2 = zeros(L,L,numel(Fotos));

for k=1:numel(Fotos)
    
    Im = imadjust(im2single(Fotos(k).data)); 
    I(:,:,k) =  Im;
    %I2(:,:,k) = imbinarize(Im);
end

figure;
% [Gmag,Gazimuth,Gelevation] = imgradient3(I);
montage(reshape(I,L,L,1,size(I,3)),'DisplayRange',[]);

%montage(reshape(Gmag,L,L,1,size(I,3)),'DisplayRange',[]);
 %figure;
 %montage(reshape(I2,L,L,1,size(I,3)));


%%

Idx = kmeans(I(:),2,'MaxIter',1000);
%Idx2 = kmeans([Bft_norm(I(:),0) alpha*Bft_norm(X(:),0)  alpha*Bft_norm(Y(:),0) alpha*Bft_norm(Z(:),0)],3);

I_seg = reshape(Idx, L, L,size(I,3));
montage(reshape(I_seg,size(I,1),size(I,2),1,size(I,3)),'DisplayRange',[]);

%I_seg2 = reshape(Idx2, size(I,1),size(I,2),size(I,3));
%montage(reshape(I_seg2,size(I,1),size(I,2),1,size(I,3)),[]);

%%
[Y,X,Z] = meshgrid(1:L,1:L,1:numel(Fotos));
alpha = 0.1;

I2 = imfill(I_seg).*I;

Idx2 = kmeans([Bft_norm(I2(:),0) alpha*Bft_norm(X(:),0)  alpha*Bft_norm(Y(:),0) alpha*Bft_norm(Z(:),0)],4);
I_seg2 = reshape(Idx2, size(I,1),size(I,2),size(I,3));
montage(reshape(I_seg2,size(I,1),size(I,2),1,size(I,3)),'DisplayRange',[]);

%%
I2 = imfill(I_seg).*I;
I_seg = fa
for k=1:size(I2,3)
    

%%

I_new = false(size(I_seg==2));
Area= [];
for k = 1:size(I_seg==2,3)
    
    Im = I_seg(:,:,k)==2;
    CC = bwconncomp(Im);
    S = regionprops(CC,'Area','Eccentricity');
    Areas = [S.Area];
    pos = find(max(Areas(Areas < max(Areas)))==Areas);
    Area(k) = Areas(pos);
    I_new(:,:,k) = labelmatrix(CC) == pos;
    
end
    
montage(reshape(I_new,size(I,1),size(I,2),1,size(I,3)),'DisplayRange',[]);

%%